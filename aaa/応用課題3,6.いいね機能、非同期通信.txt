ã„ã„ã­æ©Ÿèƒ½ã®å®Ÿè£…ã¨ã„ã„ã­ã®éåŒæœŸé€šä¿¡åŒ–

1.gemã‚’è¿½åŠ 
  <gemfile>
    gem 'jquery-rails'

  $ bundle install

2.app/assets
  <app/assets>
    javascriptsãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
    javascriptsãƒ•ã‚©ãƒ«ãƒ€ã«application.jsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

    <app/assets/javascripts/application.js>
    ä»¥ä¸‹ã‚’è¨˜è¿°
      //= require jquery
      //= require rails-ujs

  <app/assets/stylesheets>
    favorites.scssãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

    <app/assets/stylesheets/favorites.scss>
    ä»¥ä¸‹ã‚’è¨˜è¿°
      // Place all the styles related to the favorites controller here.
      // They will automatically be included in application.css.
      // You can use Sass (SCSS) here: https://sass-lang.com/


3.ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆ
  $ rails g controller favorites

  <app/controllers/favorites_controller.rb>

    class FavoritesController < ApplicationController
      before_action :authenticate_user!
      before_action :book_params

      def create
        @book = Book.find(params[:book_id])
        favorite = current_user.favorites.new(book_id: @book.id)
        favorite.save
      end


      def destroy
        @book = Book.find(params[:book_id])
        favorite = current_user.favorites.find_by(book_id: @book.id)
        favorite.destroy
      end

      private

      def book_params
        @book = Book.find(params[:book_id])
      end
    end


3.ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆ
  $ rails g model favorite

  <db/migrate/ä½œæˆæ—¥_cretae_favorites.rb> *ã®éƒ¨åˆ†ã‚’è¿½è¨˜

  class CreateFavorites < ActiveRecord::Migration[6.1]
    def change
      create_table :favorites do |t|
        *t.integer :user_id
        *t.integer :book_id

        t.timestamps
      end
    end
  end


  $ rails db:migrate


4.ãƒ¢ãƒ‡ãƒ«ã«è¨˜è¿° (å¿…è¦ãªè¨˜è¿°ã®ã¿è¨˜è¼‰ï¼‰
  <app/models/book.rb>

    class Book < ApplicationRecord

      has_many :favorites, dependent: :destroy
      has_many :favorited_users, through: :favorites, source: :user

      def favorited_by?(user)
        favorites.where(user_id: user.id).exists?
      end
    end


  <app/models/favorite.rb>

    class Favorite < ApplicationRecord
      belongs_to :user
      belongs_to :book
    end


  <app/models/user.rb>

    class User < ApplicationRecord
      has_many :favorites, dependent: :destroy

      def favorited_by?(book_id)
        favorites.where(book_id: book.id).exists?
      end
    end


5.Viewã‚’è¨˜è¿°ï¼ˆå¿…è¦ãªè¨˜è¿°ã®ã¿è¨˜è¼‰ï¼‰
  <app/views/favorites/_favorite.html.erb>

    <% if book.favorited_by?(current_user) %>  <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã„ã„ã­ã€ã‚’æŠ¼ã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤åˆ¥ã™ã‚‹ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ -->
      <%= link_to book_favorites_path(book), method: :delete, remote: true do %>
        ğŸ’–
        <%= book.favorites.count %>  <!--ã€€ãã®æœ¬ã®æŠ•ç¨¿ã«ä½•å€‹ã€Œã„ã„ã­ã€ãŒã¤ã„ã¦ã„ã‚‹ã‹ -->
      <% end %>
    <% else %>
      <%= link_to book_favorites_path(book), method: :post, remote: true do %>
        â™¡
        <%= book.favorites.count %>
      <% end %>
    <% end %>


  <app/views/books/_index.html.erb>
    æŠ•ç¨¿ä¸€è¦§ã®ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã«

    <td>
      <div id="book_favorites_<%= book.id %>">
        <%= render 'favorites/favorite', book: book %>
      </div>
    </td>


6.éåŒæœŸé€šä¿¡ã®ãŸã‚ã«viewãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
  app/view/favorites ã®é…ä¸‹ã« create.js.erb ã‚’ä½œæˆ
  app/view/favorites ã®é…ä¸‹ã« destroy.js.erb ã‚’ä½œæˆ

  <app/views/favorites/create.js.erb>
    $('#book_favorites_<%= @book.id %>').html("<%= j(render "favorites/favorite", book: @book) %>");

  <app/views/favorites/destroy.js.erb>
    $('#book_favorites_<%= @book.id %>').html("<%= j(render "favorites/favorite", book: @book) %>");


7.ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨˜è¿°
  <config/routes.rb>
    resources :books, only: [:index,:show,:edit,:create,:destroy,:update] do
      resource :favorites, only: [:create, :destroy]
    end